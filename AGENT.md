# AGENT.md

> Long-term memory & constraints for LLMs/Agents/Copilots working on Tainiex Lens

## Principle

- You should detect the OS type before using any tools to ensure you use the correct one (PowerShell, Bash, Zsh, etc.).
- Save the plan file and all related data generated by the code agent to the .llm directory.

---

## Quick Reference

### Basic Info

- **Project Name**: Tainiex Lens (Web)
- **Type**: Pure Frontend (React + Vite)
- **Structure**:
    - `src/`: Main Application Code
    - `src/shared/`: Shared Logic (API, Socket, Types) - formerly `packages/shared-lens`
- **Version**: v0.2.0 (Pure Frontend Refactor)
- **Quick Start**:
    - **Install**: `yarn install`
    - **Dev**: `yarn dev` (localhost:2000)

### Tech Stack

| Technology                | Version | Purpose                                   |
| ------------------------- | ------- | ----------------------------------------- |
| **React**                 | 18.3.1  | Web UI                                    |
| **Vite**                  | 7.2.4   | Web Bundler                               |
| **Yarn**                  | 1.22.x  | Package Manager                           |
| **@tainiex/shared-atlas** | 0.0.19  | **Single Source of Truth** for DTOs/Types |

**Developer Rules**

- **Strict Conformity**: Always use types/DTOs from `@tainiex/shared-atlas` for API payloads. **Never** manually redefine interfaces or use `any` for DTOs.
- **Unified Logic**: `src/shared` contains business logic, API clients, and hooks.
- **Rich Content**: Markdown (GFM), LaTeX, and Mermaid support via Tiptap.

---

## Project Architecture

### Directory Structure

```
c:\Users\Cselerity\Codes\tainiex-lens\
├── src/
│   ├── components/             # React Components
│   ├── shared/                 # Shared Logic (API, Services, Types)
│   ├── pages/                  # Route Pages
│   └── ...
├── package.json                # Project Configuration
├── vite.config.ts              # Vite Configuration
└── .npmrc                      # Private registry config (gitignored)
```

### Shared Logic (`src/shared`)

- **Purpose**: Centralized logic for API communication and WebSocket state.
- **Exports**:
    - `apiClient`: Axios instance with interceptors.
    - `socketService`: Singleton socket manager.
    - `hooks/*`: React hooks (e.g., `useChat`, `useMessageHistory`).
    - `types/*`: Shared TypeScript interfaces.

---

## Environment Setup

### Prerequisites

- **Node.js**: v20+
- **Yarn**: `npm install -g yarn`
- **GitHub PAT**: `read:packages` scope required for `@tainiex` registry.

### Configuration Steps

#### Step 1: Configure Credentials

Root `.npmrc` handles the private registry auth:

```ini
"@tainiex:registry" "https://npm.pkg.github.com"
```

Ensure your environment provides the auth token.

#### Step 2: Install

```bash
yarn install
```

#### Step 3: Run

```bash
yarn dev
```

---

## UI & UX Standards

### Sidebar Layout

- **Compactness**: Reduced vertical and horizontal spacing.
- **Menu Order**: Chat, Notes.
- **Grouping**: "Recent 7 Days" / "Earlier".

### Editor Components

- **Slash Commands**: Triggered by `/`. Implemented via `@tiptap/suggestion` + `tippy.js`.
- **Code Blocks**: Syntax highlighting via `lowlight`. Custom `CodeBlockComponent` with language selector.
- **Performance Fix**: `flushSync` warnings in Tiptap's `ReactRenderer` are suppressed using `patch-package`.
    - **Rule**: Never call `flushSync` inside React lifecycle methods.
    - **Warning Prevention**: Defer state updates in components like `CommandList.tsx` using `queueMicrotask`.

### Layout Consistency

- **Alignment**: Welcome screen content aligns with chat input placeholder.
- **Limiter**: `max-width: 900px` on content containers.

---

## Security Best Practices

### Credentials Management

- **NEVER commit credentials**: The `.npmrc` file containing GitHub Personal Access Tokens is gitignored.
- **Environment Variables**: Use `.env` files for sensitive configuration (gitignored).
- **Token Setup**: Each developer must create their own `.npmrc` with `read:packages` scope PAT.
- **HttpOnly Cookies**: Authentication tokens use HttpOnly cookies.

### Private Package Access

To access `@tainiex/shared-atlas` from GitHub Package Registry:

1. Generate PAT with `read:packages` scope.
2. Create `~/.npmrc` or project `.npmrc` (gitignored).

---

## Y.js Architecture

### YDocManager Service

Location: `src/shared/services/YDocManager.ts`

**Purpose**: Manages Y.js CRDT document synchronization for collaborative editing.
