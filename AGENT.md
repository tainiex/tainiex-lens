# AGENT.md

> Long-term memory & constraints for LLMs/Agents/Copilots working on Tainiex Lens

## Logging (Global Log Level)

Location: `src/shared/utils/logger.ts`

**Design**

- Use the shared `logger` for all debug/trace-style diagnostics. Avoid ad-hoc `console.log` in application code.
- Logging is controlled by a single global level via Vite env var: `VITE_LOG_LEVEL`
    - Allowed values: `debug` | `log` | `warn` | `error`
- **Default behavior**
    - **Development**: defaults to `debug`
    - **Production**: defaults to `warn` (debug/log are suppressed)
- Use `logger.debug(...)` for noisy instrumentation (e.g., skeleton timing diagnostics) so it never ships as console noise in production unless explicitly configured.

**Notes**

- If you need to change verbosity, set `VITE_LOG_LEVEL` in your environment (e.g. `.env.development` / build pipeline).

## Principle

- You should detect the OS type before using any tools to ensure you use the correct one (PowerShell, Bash, Zsh, etc.).
- Save the plan file and all related data generated by the code agent to the .llm directory.

---

## Quick Reference

### Basic Info

- **Project Name**: Tainiex Lens (Web)
- **Type**: Pure Frontend (React + Vite)
- **Structure**:
    - `src/`: Main Application Code
    - `src/shared/`: Shared Logic (API, Socket, Types) - formerly `packages/shared-lens`
- **Version**: v0.2.0 (Pure Frontend Refactor)
- **Quick Start**:
    - **Install**: `yarn install`
    - **Dev**: `yarn dev` (localhost:2000)

### Tech Stack

| Technology                | Version | Purpose                                   |
| ------------------------- | ------- | ----------------------------------------- |
| **React**                 | 18.3.1  | Web UI                                    |
| **Vite**                  | 7.2.4   | Web Bundler                               |
| **Yarn**                  | 1.22.x  | Package Manager                           |
| **@tainiex/shared-atlas** | 0.0.19  | **Single Source of Truth** for DTOs/Types |

**Developer Rules**

- **Strict Conformity**: Always use types/DTOs from `@tainiex/shared-atlas` for API payloads. **Never** manually redefine interfaces or use `any` for DTOs.
- **Unified Logic**: `src/shared` contains business logic, API clients, and hooks.
- **Rich Content**: Markdown (GFM), LaTeX, and Mermaid support via Tiptap.

---

## Project Architecture

### Directory Structure

```
c:\Users\Cselerity\Codes\tainiex-lens\
├── src/
│   ├── components/             # React Components
│   ├── shared/                 # Shared Logic (API, Services, Types)
│   ├── pages/                  # Route Pages
│   └── ...
├── package.json                # Project Configuration
├── vite.config.ts              # Vite Configuration
└── .npmrc                      # Private registry config (gitignored)
```

### Shared Logic (`src/shared`)

- **Purpose**: Centralized logic for API communication and WebSocket state.
- **Exports**:
    - `apiClient`: Axios instance with interceptors.
    - `socketService`: Singleton socket manager.
    - `hooks/*`: React hooks (e.g., `useChat`, `useMessageHistory`).
    - `types/*`: Shared TypeScript interfaces.

---

## Environment Setup

### Prerequisites

- **Node.js**: v20+
- **Yarn**: `npm install -g yarn`
- **GitHub PAT**: `read:packages` scope required for `@tainiex` registry.

### Configuration Steps

#### Step 1: Configure Credentials

Root `.npmrc` handles the private registry auth:

```ini
"@tainiex:registry" "https://npm.pkg.github.com"
```

Ensure your environment provides the auth token.

#### Step 2: Install

```bash
yarn install
```

#### Step 3: Run

```bash
yarn dev
```

---

## UI & UX Standards

### Sidebar Layout

- **Compactness**: Reduced vertical and horizontal spacing.
- **Menu Order**: Chat, Notes.
- **Grouping**: "Recent 7 Days" / "Earlier".

### Editor Components

- **Slash Commands**: Triggered by `/`. Implemented via `@tiptap/suggestion` + `tippy.js`.
- **Code Blocks**: Syntax highlighting via `lowlight`. Custom `CodeBlockComponent` with language selector.
- **Performance Fix**: `flushSync` warnings in Tiptap's `ReactRenderer` are suppressed using `patch-package`.
    - **Rule**: Never call `flushSync` inside React lifecycle methods.
    - **Warning Prevention**: Defer state updates in components like `CommandList.tsx` using `queueMicrotask`.

### Layout Consistency

- **Alignment**: Welcome screen content aligns with chat input placeholder.
- **Limiter**: `max-width: 900px` on content containers.

---

## Security Best Practices

### Credentials Management

- **NEVER commit credentials**: The `.npmrc` file containing GitHub Personal Access Tokens is gitignored.
- **Environment Variables**: Use `.env` files for sensitive configuration (gitignored).
- **Token Setup**: Each developer must create their own `.npmrc` with `read:packages` scope PAT.
- **HttpOnly Cookies**: Authentication tokens use HttpOnly cookies.

### Private Package Access

To access `@tainiex/shared-atlas` from GitHub Package Registry:

1. Generate PAT with `read:packages` scope.
2. Create `~/.npmrc` or project `.npmrc` (gitignored).

---

## Chat Skeleton Screen Optimization

### Problem Context

During chat session switching, users experienced two critical UX issues:

1. **White flash**: Skeleton → Disappears → White screen → Content appears
2. **Position jumping**: Skeleton appeared at different vertical positions

### Solution Architecture

#### 1. Delayed Skeleton Gate (120ms)

**Purpose**: Avoid skeleton flashing on fast session switches.

```typescript
// ChatContext.tsx
const SKELETON_DELAY_MS = 120;

// On session change:
- Set isHistoryReady = false
- Start 120ms timer
- If data arrives < 120ms → No skeleton, direct switch
- If data arrives > 120ms → Show skeleton
```

**Benefits**:

- Fast API responses (< 120ms): Zero skeleton, instant switch
- Slow responses (> 120ms): Skeleton prevents blank screen

#### 2. isHistoryReady State

**Purpose**: Track precise data readiness state.

- **Dedicated state** instead of reusing `isLoading`
- Set by `useChat` hook when messages are hydrated
- Supports `skipFetch` scenarios (empty sessions)

#### 3. No Message Clearing

**Critical Fix**: ChatContext **no longer calls** `setMessages([])` on session change.

**Why**:

- Clearing creates "empty frame" → White flash
- `useChat` naturally replaces messages when data arrives
- Keeps old messages visible until new data loads → Smooth transition

#### 4. Layout Consistency

**Skeleton layout** matches actual message list:

```typescript
flex: 1,
minHeight: 0,              // Dynamic height, not fixed
justifyContent: 'flex-end', // Bottom-aligned (chat style)
padding: '1rem',            // Matches message padding
```

### Implementation Files

- **ChatContext.tsx**: `isHistoryReady`, `shouldShowSkeleton`, delayed gate logic
- **SmoothLoader.tsx**: Simplified `canHide` state (removed phase state machine)
- **ChatMessages.tsx**: Uses `shouldShowSkeleton`, bottom-aligned skeleton

### Debug Logging

Skeleton timing diagnostics use `logger.debug('[SkeletonDebug]...')` tags.

**View logs**:

```bash
VITE_LOG_LEVEL=debug yarn dev
```

Look for:

- `[SkeletonDebug][ChatMessages]`: Render-time states
- `[SkeletonDebug][SmoothLoader]`: minDuration timing

---

## Y.js Architecture

### YDocManager Service

Location: `src/shared/services/YDocManager.ts`

**Purpose**: Manages Y.js CRDT document synchronization for collaborative editing.
